<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat</title>
  <style>
    :root{
      --bg:#fff; --text:#000; --muted:#666; --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",monospace}
    .container{display:grid;grid-template-columns:280px 1fr;gap:var(--gap);padding:14px;height:100vh}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center}
    .panel{border:1px solid #000;padding:12px;background:transparent;border-radius:4px}
    .groups{display:flex;flex-direction:column;gap:6px;max-height:40vh;overflow:auto;margin-bottom:8px}
    .groupItem{padding:6px;border:1px solid #000;cursor:pointer}
    .groupItem.active{background:#eee}
    .controls{display:flex;gap:6px;margin-top:6px}
    .controls input{flex:1;padding:6px;border:1px solid #000;background:transparent}
    .controls button{padding:6px 8px;border:1px solid #000;background:transparent;cursor:pointer}
    .chatPanel{display:flex;flex-direction:column;height:calc(100vh - 160px)}
    .chatWindow{flex:1;border:1px solid #000;padding:12px;overflow:auto;white-space:pre-wrap}
    .chatLine{margin:0 0 6px 0}
    .msgForm{display:flex;gap:6px;margin-top:8px}
    .msgForm input{flex:1;padding:8px;border:1px solid #000;background:transparent}
    .msgForm button{padding:8px 10px;border:1px solid #000;background:transparent;cursor:pointer}
    .authPanel{position: absolute; right: 16px; top: 72px; width: 260px; padding:12px; border:1px solid #000; background:#fff;}
    .authPanel input{width:100%;padding:8px;margin-bottom:6px;border:1px solid #000;background:transparent}
    .authBtns{display:flex;gap:6px;justify-content:space-between}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    @media (max-width:700px){.container{grid-template-columns:1fr}.authPanel{position:static;width:100%;margin-top:8px}}
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h1>Retro Chat</h1>
      <div id="userArea">
        <span id="showUser"></span>
        <button id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <section class="left">
      <div class="panel">
        <h2>Groups</h2>
        <div id="groupsList" class="groups">(loading...)</div>

        <div class="controls">
          <input id="newGroupName" placeholder="Group name" />
          <button id="createGroupBtn">Create</button>
        </div>

        <div class="controls">
          <input id="inviteCode" placeholder="Invite code" />
          <button id="joinBtn">Join</button>
        </div>

        <div style="margin-top:8px;font-size:12px;color:var(--muted)">
          Invite codes are 8-char codes. Groups are invite-only (people need the code).
        </div>
      </div>
    </section>

    <section class="right">
      <div class="panel chatPanel">
        <div id="chatHeader">No group selected</div>
        <div id="chat" class="chatWindow" aria-live="polite"></div>

        <form id="msgForm" class="msgForm">
          <input id="msgInput" autocomplete="off" placeholder="Type a message..." />
          <button id="sendBtn">Send</button>
        </form>
      </div>
    </section>

    <div id="auth" class="authPanel panel">
      <h2>Sign in / Register</h2>
      <input id="username" placeholder="username (3-24, letters/numbers/_-. )" />
      <input id="password" type="password" placeholder="password (min 6)" />
      <div class="authBtns">
        <button id="login">Login</button>
        <button id="register">Register</button>
      </div>
      <p class="hint">Usernames are unique and can't be reused. Passwords are handled by Firebase Auth (secure).</p>
    </div>
  </main>

  <!-- Firebase compat SDKs (easy for single-file deployment) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
import { getDatabase, ref, set, push, onValue, get } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyC4HaUzTDQsz1AKUCsv1ieY5G9WrCyTHrw",
  authDomain: "website-11b5c.firebaseapp.com",
  databaseURL: "https://website-11b5c-default-rtdb.firebaseio.com",
  projectId: "website-11b5c",
  storageBucket: "website-11b5c.firebasestorage.app",
  messagingSenderId: "821866548441",
  appId: "1:821866548441:web:00a08e534699a6f97902c8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// === DOM Elements ===
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const registerBtn = document.getElementById('register');
const loginBtn = document.getElementById('login');
const createGroupBtn = document.getElementById('createGroupBtn');
const joinGroupBtn = document.getElementById('joinBtn');
const groupListDiv = document.getElementById('groupsList');
const messages = document.getElementById('chat');
const authPanel = document.getElementById('auth');
const showUser = document.getElementById('showUser');
const logoutBtn = document.getElementById('logoutBtn');

let currentUser = null;
let currentGroupId = null;

// === Simple cookie handling ===
function setCookie(name, value, days = 365) {
  const d = new Date();
  d.setTime(d.getTime() + days * 864e5);
  document.cookie = `${name}=${encodeURIComponent(value)};path=/;expires=${d.toUTCString()}`;
}
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}

// === Auth ===
registerBtn.onclick = async () => {
  const name = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!name || !pass) return alert('Enter both fields');

  await set(ref(db, 'retro/users/' + name), { password: pass });
  setCookie('username', name);
  currentUser = name;
  authPanel.style.display = 'none';
  showUser.textContent = name;
  logoutBtn.style.display = 'inline';
  loadGroups();
};

loginBtn.onclick = async () => {
  const name = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  const snap = await get(ref(db, 'retro/users/' + name));
  if (!snap.exists()) return alert('User not found');
  if (snap.val().password !== pass) return alert('Wrong password');

  setCookie('username', name);
  currentUser = name;
  authPanel.style.display = 'none';
  showUser.textContent = name;
  logoutBtn.style.display = 'inline';
  loadGroups();
};

logoutBtn.onclick = () => {
  document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
  currentUser = null;
  authPanel.style.display = 'block';
  logoutBtn.style.display = 'none';
};

// === Groups ===

// Load groups: shows public groups + invite-only groups user is member of
function loadGroups() {
  const groupsRef = ref(db, 'retro/groups');
  onValue(groupsRef, snapshot => {
    groupListDiv.innerHTML = '';
    const data = snapshot.val() || {};

    for (const id in data) {
      const group = data[id];
      const isMember = group.members && group.members[currentUser];

      // Show if public OR user is member
      if (!group.inviteOnly || isMember) {
        const div = document.createElement('div');
        div.textContent = group.name + (group.inviteOnly ? ' ðŸ”’' : '');
        div.className = 'groupItem';
        div.onclick = () => selectGroup(id);
        groupListDiv.appendChild(div);
      }
    }
  });
}

// Create group
createGroupBtn.onclick = async () => {
  if (!currentUser) return alert('Login first');
  const name = document.getElementById('newGroupName').value.trim();
  if (!name) return alert('Enter a group name');

  // Ask if invite-only
  const isInviteOnly = confirm('Make this group invite-only?');
  const inviteCode = isInviteOnly ? Math.random().toString(36).slice(2, 10) : null;

  const id = 'g_' + Math.random().toString(36).slice(2, 10);
  await set(ref(db, `retro/groups/${id}`), {
    name,
    owner: currentUser,
    inviteOnly: isInviteOnly,
    inviteCode,
    members: { [currentUser]: true } // creator is automatically a member
  });

  if (isInviteOnly) alert('Invite code: ' + inviteCode);
};

// Join group
joinGroupBtn.onclick = async () => {
  if (!currentUser) return alert('Login first');

  const code = document.getElementById('inviteCode').value.trim();
  if (!code) return alert('Enter an invite code');

  const groupsRef = ref(db, 'retro/groups');
  const snapshot = await get(groupsRef);
  const groups = snapshot.val() || {};

  // Find group with this code
  const groupId = Object.keys(groups).find(id => groups[id].inviteCode === code);
  if (!groupId) return alert('Invalid invite code');

  // Add user as member
  await set(ref(db, `retro/groups/${groupId}/members/${currentUser}`), true);

  // Open the chat
  selectGroup(groupId);
  alert('Joined group: ' + groups[groupId].name);
};

// === Messages ===
function selectGroup(id) {
  currentGroupId = id;
  messages.innerHTML = '';
  const msgsRef = ref(db, 'retro/messages/' + id);
  onValue(msgsRef, snapshot => {
    messages.innerHTML = '';
    const msgs = snapshot.val() || {};
    for (const mid in msgs) {
      const { sender, text } = msgs[mid];
      const line = document.createElement('div');
      line.className = 'chatLine';
      line.textContent = `${sender} > ${text}`;
      messages.appendChild(line);
    }
    messages.scrollTop = messages.scrollHeight;
  });
}

sendBtn.onclick = async e => {
  e.preventDefault();
  if (!currentGroupId || !currentUser) return;
  const text = msgInput.value.trim();
  if (!text) return;
  const newMsgRef = push(ref(db, 'retro/messages/' + currentGroupId));
  await set(newMsgRef, { sender: currentUser, text, ts: Date.now() });
  msgInput.value = '';
};

// === Auto-login ===
const cookieUser = getCookie('username');
if (cookieUser) {
  currentUser = cookieUser;
  authPanel.style.display = 'none';
  showUser.textContent = cookieUser;
  logoutBtn.style.display = 'inline';
  loadGroups();
}
</script>

</body>
</html>
