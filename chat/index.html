<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat</title>
  <style>
    :root{
      --bg:#fff; --text:#000; --muted:#666; --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono",monospace}
    .container{display:grid;grid-template-columns:280px 1fr;gap:var(--gap);padding:14px;height:100vh}
    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center}
    .panel{border:1px solid #000;padding:12px;background:transparent;border-radius:4px}
    .groups{display:flex;flex-direction:column;gap:6px;max-height:40vh;overflow:auto;margin-bottom:8px}
    .groupItem{padding:6px;border:1px solid #000;cursor:pointer}
    .groupItem.active{background:#eee}
    .controls{display:flex;gap:6px;margin-top:6px}
    .controls input{flex:1;padding:6px;border:1px solid #000;background:transparent}
    .controls button{padding:6px 8px;border:1px solid #000;background:transparent;cursor:pointer}
    .chatPanel{display:flex;flex-direction:column;height:calc(100vh - 160px)}
    .chatWindow{flex:1;border:1px solid #000;padding:12px;overflow:auto;white-space:pre-wrap}
    .chatLine{margin:0 0 6px 0}
    .msgForm{display:flex;gap:6px;margin-top:8px}
    .msgForm input{flex:1;padding:8px;border:1px solid #000;background:transparent}
    .msgForm button{padding:8px 10px;border:1px solid #000;background:transparent;cursor:pointer}
    .authPanel{position: absolute; right: 16px; top: 72px; width: 260px; padding:12px; border:1px solid #000; background:#fff;}
    .authPanel input{width:100%;padding:8px;margin-bottom:6px;border:1px solid #000;background:transparent}
    .authBtns{display:flex;gap:6px;justify-content:space-between}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    @media (max-width:700px){.container{grid-template-columns:1fr}.authPanel{position:static;width:100%;margin-top:8px}}
  </style>
</head>
<body>
  <main class="container">
    <header>
      <h1>Retro Chat</h1>
      <div id="userArea">
        <span id="showUser"></span>
        <button id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <section class="left">
      <div class="panel">
        <h2>Groups</h2>
        <div id="groupsList" class="groups">(loading...)</div>

        <div class="controls">
          <input id="newGroupName" placeholder="Group name" />
          <button id="createGroupBtn">Create</button>
        </div>

        <div class="controls">
          <input id="inviteCode" placeholder="Invite code" />
          <button id="joinBtn">Join</button>
        </div>

        <div style="margin-top:8px;font-size:12px;color:var(--muted)">
          Invite codes are 8-char codes. Groups are invite-only (people need the code).
        </div>
      </div>
    </section>

    <section class="right">
      <div class="panel chatPanel">
        <div id="chatHeader">No group selected</div>
        <div id="chat" class="chatWindow" aria-live="polite"></div>

        <form id="msgForm" class="msgForm">
          <input id="msgInput" autocomplete="off" placeholder="Type a message..." />
          <button>Send</button>
        </form>
      </div>
    </section>

    <div id="auth" class="authPanel panel">
      <h2>Sign in / Register</h2>
      <input id="username" placeholder="username (3-24, letters/numbers/_-. )" />
      <input id="password" type="password" placeholder="password (min 6)" />
      <div class="authBtns">
        <button id="login">Login</button>
        <button id="register">Register</button>
      </div>
      <p class="hint">Usernames are unique and can't be reused. Passwords are handled by Firebase Auth (secure).</p>
    </div>
  </main>

  <!-- Firebase compat SDKs (easy for single-file deployment) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
import { getDatabase, ref, set, push, onValue, get } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyC4HaUzTDQsz1AKUCsv1ieY5G9WrCyTHrw",
  authDomain: "website-11b5c.firebaseapp.com",
  databaseURL: "https://website-11b5c-default-rtdb.firebaseio.com",
  projectId: "website-11b5c",
  storageBucket: "website-11b5c.firebasestorage.app",
  messagingSenderId: "821866548441",
  appId: "1:821866548441:web:00a08e534699a6f97902c8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// === DOM Elements ===
const msgInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const settings = document.getElementById('settingsToggle');
const settingsMenu = document.getElementById('settingsPanel');
const darkModeToggle = document.getElementById('darkMode');
const pfpColor = document.getElementById('profileColor');
const usernameInput = document.getElementById('fullNameInput');
const passwordInput = document.getElementById('passwordInput');
const joinBtn = document.getElementById('createProfileBtn');
const groupListDiv = document.getElementById('groupList');
const createGroupBtn = document.getElementById('btnCreateGroup');
const joinGroupBtn = document.getElementById('confirmJoinGrp');
const messages = document.getElementById('chat');

let currentUser = null;
let currentGroupId = null;

// === Helper functions ===
function getInitials(name) {
  const words = name.trim().split(' ');
  return words.length === 1
    ? words[0][0].toUpperCase()
    : (words[0][0] + words[words.length - 1][0]).toUpperCase();
}

function setCookie(name, value, days = 365) {
  const d = new Date();
  d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
  document.cookie = name + '=' + encodeURIComponent(value) + ';path=/;expires=' + d.toUTCString();
}
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}

// === Login handling ===
joinBtn.onclick = async () => {
  const name = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!name || !pass) return alert('Enter both fields');

  currentUser = name;
  setCookie('username', name);
  setCookie('password', pass);

  await set(ref(db, 'retro/users/' + name), {
    color: localStorage.getItem('pfpColor') || '#4c8bf5'
  });
  document.getElementById('loginModal').style.display = 'none';
  loadGroups();
};

// === Load groups ===
function loadGroups() {
  const groupsRef = ref(db, 'retro/groups');
  onValue(groupsRef, snapshot => {
    const data = snapshot.val() || {};
    groupListDiv.innerHTML = '';
    for (const id in data) {
      const g = data[id];
      const div = document.createElement('div');
      div.textContent = g.name;
      div.className = 'groupEntry';
      div.onclick = () => selectGroup(id);
      groupListDiv.appendChild(div);
    }
  });
}

// === Select group ===
function selectGroup(id) {
  currentGroupId = id;
  messages.innerHTML = '';
  const msgsRef = ref(db, 'retro/messages/' + id);
  onValue(msgsRef, snapshot => {
    messages.innerHTML = '';
    const msgs = snapshot.val() || {};
    for (const mid in msgs) {
      addMessage(msgs[mid].sender, msgs[mid].text);
    }
  });
}

// === Send message ===
sendBtn.onclick = async () => {
  if (!currentGroupId) return alert('Select a group first');
  const text = msgInput.value.trim();
  if (!text) return;

  const newMsgRef = push(ref(db, 'retro/messages/' + currentGroupId));
  await set(newMsgRef, { sender: currentUser, text, ts: Date.now() });
  msgInput.value = '';
};

// === Press Enter to send ===
msgInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

// === Add message bubble ===
async function addMessage(name, text) {
  // Escape HTML to prevent XSS
  const safeText = text.replace(/[<>&]/g, c =>
    ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c])
  );

  const row = document.createElement('div');
  row.className = 'messageRow' + (name === currentUser ? ' me' : '');

  const pfp = document.createElement('div');
  pfp.className = 'msgPfp';
  pfp.textContent = getInitials(name);

  get(ref(db, 'retro/users/' + name)).then(snapshot => {
    const data = snapshot.val();
    if (data && data.color) pfp.style.background = data.color;
    else pfp.style.background = '#4c8bf5';
  });

  const msg = document.createElement('div');
  msg.className = 'message' + (name === currentUser ? ' me' : '');
  const meta = document.createElement('div');
  meta.className = 'msgMeta';
  meta.textContent = name;
  const bubble = document.createElement('div');
  bubble.textContent = safeText;
  msg.appendChild(meta);
  msg.appendChild(bubble);

  row.appendChild(pfp);
  row.appendChild(msg);
  messages.appendChild(row);
  messages.scrollTop = messages.scrollHeight;
}

// === Settings ===
settings.onclick = () => {
  settingsMenu.style.display =
    settingsMenu.style.display === 'none' ? 'flex' : 'none';
};
document.getElementById('closeSettings').onclick = () => {
  settingsMenu.style.display = 'none';
};

// === Profile color ===
pfpColor.oninput = e => {
  const color = e.target.value;
  localStorage.setItem('pfpColor', color);
  document.getElementById('profileCircleTop').style.background = color;
  document.getElementById('leftProfile').style.background = color;

  if (currentUser) {
    set(ref(db, 'retro/users/' + currentUser + '/color'), color);
  }
};

// === Dark mode ===
darkModeToggle.onchange = e => {
  document.documentElement.dataset.theme = e.target.checked ? 'dark' : '';
  localStorage.setItem('darkMode', e.target.checked);
};
if (localStorage.getItem('darkMode') === 'true') {
  document.documentElement.dataset.theme = 'dark';
  darkModeToggle.checked = true;
}
if (localStorage.getItem('pfpColor')) {
  pfpColor.value = localStorage.getItem('pfpColor');
}

// === Create / Join groups ===
createGroupBtn.onclick = () => {
  const name = prompt('Group name');
  if (!name) return;
  const id = 'g_' + Date.now().toString(36);
  set(ref(db, 'retro/groups/' + id), { name, owner: currentUser });
};

joinGroupBtn.onclick = () => {
  const id = prompt('Enter group ID to join');
  if (!id) return;
  set(ref(db, 'retro/groups/' + id + '/members/' + currentUser), true);
};

// === Auto login ===
const cookieUser = getCookie('username');
if (cookieUser) {
  currentUser = cookieUser;
  document.getElementById('loginModal').style.display = 'none';
  loadGroups();
} else {
  document.getElementById('loginModal').style.display = 'flex';
}

  </script>
</body>
</html>
