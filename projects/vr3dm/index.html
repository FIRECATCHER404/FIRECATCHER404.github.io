<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D Music Visualizer (VR-ready)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; background:#0b0b10; color:#ddd; font-family:system-ui,Segoe UI,Roboto,Arial; }
    #ui {
      position: absolute;
      left: 12px;
      top: 12px;
      background: rgba(10,10,12,0.6);
      padding: 10px;
      border-radius: 8px;
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    #ui * { display:block; margin:6px 0; }
    label { font-size:13px; color:#fff; }
    button,input,select { font-size:14px; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03); color:#fff; }
    #credits { position: absolute; right: 12px; bottom: 12px; color: #888; font-size:13px; }
  </style>
</head>
<body>
  <!-- Desktop-only UI (not visible in VR) -->
  <div id="ui">
    <label>Pick a song (desktop)</label>
    <input id="file" type="file" accept="audio/*" />
    <div style="display:flex; gap:6px;">
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
    </div>

    <label>Sensitivity</label>
    <input id="sensitivity" type="range" min="0.2" max="5" step="0.01" value="1.4" />

    <label>Bar Color</label>
    <input id="color" type="color" value="#ff4d4d" />

    <label>Bars</label>
    <select id="bars">
      <option value="64">64</option>
      <option value="128" selected>128</option>
      <option value="256">256</option>
    </select>
  </div>

  <div id="credits">3D Music Visualizer — Works on Desktop & Quest VR</div>

  <script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
import { VRButton } from 'three/examples/jsm/webxr/VRButton.js';

// Scene, camera, renderer
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x07070a);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 6, 18);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

// Enable WebXR
renderer.xr.enabled = true;
document.body.appendChild(VRButton.createButton(renderer));

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// Lights
const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 0.5);
scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.9);
dir.position.set(5, 10, 7);
scene.add(dir);

// Floor / subtle grid
const grid = new THREE.GridHelper(50, 50, 0x222233, 0x0c0c0f);
grid.material.opacity = 0.12;
grid.material.transparent = true;
scene.add(grid);

// UI elements (desktop only)
const fileInput = document.getElementById('file');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const sensitivityEl = document.getElementById('sensitivity');
const colorEl = document.getElementById('color');
const barsSelect = document.getElementById('bars');

// Audio setup
let audioCtx = null;
let analyser = null;
let dataArray = null;
let sourceNode = null;
let audioElement = new Audio('/vr3dm/public/mysong.ogg');
let isPlaying = true;
audioElement.crossOrigin = "anonymous"
audioElement.loop = true

audioElement.addEventListener('canplay', () => {
  ensureAudio()
  sourceNode = audioCtx.createMediaElementSource(audioElement)
  initAnalyser()
  sourceNode.connect(analyser)
  analyser.connect(audioCtx.destination)
  audioElement.play()
  isPlaying = true
})

function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

document.body.appendChild(VRButton.createButton(renderer))

renderer.xr.addEventListener('sessionstart', () => {
  console.log('VR Session started — resuming audio')

  ensureAudio()
  sourceNode = audioCtx.createMediaElementSource(audioElement)
  initAnalyser()
  sourceNode.connect(analyser)
  analyser.connect(audioCtx.destination)

  // resume audio context and play
  audioCtx.resume().then(() => {
    audioElement.play()
  })
})

// Visualizer instanced bars
let instanceCount = parseInt(barsSelect.value, 10);
let instancedMesh = null;
let indicesToFreq = [];
const radius = 6;
const barWidth = 0.25;
const barDepth = 0.8;
const baseHeight = 0.1;

function setupInstances(count) {
  if (instancedMesh) {
    scene.remove(instancedMesh);
    instancedMesh.geometry.dispose();
    instancedMesh.material.dispose();
    instancedMesh = null;
  }

  instanceCount = count;
  const geometry = new THREE.BoxGeometry(barWidth, 1, barDepth);
  const material = new THREE.MeshStandardMaterial({ color: colorEl.value, emissive: colorEl.value, emissiveIntensity: 0.25, metalness: 0.1, roughness: 0.6 });
  instancedMesh = new THREE.InstancedMesh(geometry, material, instanceCount);
  instancedMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
  scene.add(instancedMesh);

  // initial placement around circle
  indicesToFreq = [];
  for (let i = 0; i < instanceCount; i++) {
    const angle = (i / instanceCount) * Math.PI * 2;
    const x = Math.cos(angle) * radius;
    const z = Math.sin(angle) * radius;

    const m = new THREE.Matrix4();
    const pos = new THREE.Vector3(x, baseHeight / 2, z);
    const lookAt = new THREE.Vector3(0, 0, 0);
    const up = new THREE.Vector3(0,1,0);
    const quat = new THREE.Quaternion().setFromRotationMatrix(new THREE.Matrix4().lookAt(pos, lookAt, up));
    const scale = new THREE.Vector3(1, baseHeight, 1);

    m.compose(pos, quat, scale);
    instancedMesh.setMatrixAt(i, m);

    indicesToFreq.push(Math.floor((i / instanceCount) * 1024));
  }
  instancedMesh.instanceMatrix.needsUpdate = true;
}
setupInstances(instanceCount);

// UI changes (desktop)
barsSelect.addEventListener('change', () => {
  setupInstances(parseInt(barsSelect.value, 10));
  initAnalyser();
});
colorEl.addEventListener('input', () => {
  if (instancedMesh) {
    instancedMesh.material.color.set(colorEl.value);
    instancedMesh.material.emissive.set(colorEl.value);
  }
});

// build analyser (or update)
function initAnalyser() {
  if (!audioCtx) return;
  if (!analyser) {
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
  }
  const bins = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bins);

  indicesToFreq = [];
  for (let i = 0; i < instanceCount; i++) {
    const t = i / instanceCount;
    const idx = Math.floor(((Math.pow(2, t * 8) - 1) / (Math.pow(2, 8) - 1)) * (bins - 1));
    indicesToFreq.push(Math.min(bins - 1, Math.max(0, idx)));
  }
}

// play / pause handlers
playBtn.addEventListener('click', async () => {
  ensureAudio();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  if (audioElement) {
    audioElement.play();
    isPlaying = true;
  }
});
pauseBtn.addEventListener('click', () => {
  if (audioElement) {
    audioElement.pause();
    isPlaying = false;
  }
});

// file input
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  ensureAudio();

  if (audioElement) {
    audioElement.pause();
    audioElement.src = '';
    audioElement.remove();
  }

  audioElement = document.createElement('audio');
  audioElement.src = URL.createObjectURL(f);
  audioElement.crossOrigin = "anonymous";
  audioElement.loop = true;

  sourceNode = audioCtx.createMediaElementSource(audioElement);
  initAnalyser();
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  audioElement.play();
  isPlaying = true;
});

// core animation
const clock = new THREE.Clock();
function animate() {
  renderer.setAnimationLoop(() => {
    const dt = clock.getDelta();

    // read frequency data
    if (analyser && dataArray) {
      analyser.getByteFrequencyData(dataArray);
      const sensitivity = parseFloat(sensitivityEl.value);

      const tmpMat = new THREE.Matrix4();
      const pos = new THREE.Vector3();
      const quat = new THREE.Quaternion();
      const scale = new THREE.Vector3();

      for (let i = 0; i < instanceCount; i++) {
        const freqIdx = indicesToFreq[i];
        const v = dataArray[freqIdx] / 255;
        const height = Math.max(baseHeight, v * sensitivity * 8);

        const angle = (i / instanceCount) * Math.PI * 2;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        pos.set(x, height / 2, z);

        const lookAt = new THREE.Vector3(0, pos.y, 0);
        quat.setFromRotationMatrix(new THREE.Matrix4().lookAt(pos, lookAt, new THREE.Vector3(0,1,0)));

        scale.set(1, height, 1);
        tmpMat.compose(pos, quat, scale);
        instancedMesh.setMatrixAt(i, tmpMat);
      }
      instancedMesh.instanceMatrix.needsUpdate = true;

      const bass = (dataArray[20] || 0) / 255;
      if (instancedMesh && instancedMesh.material) {
        const col = new THREE.Color(colorEl.value).multiplyScalar(0.6 + Math.min(1, bass * 1.5));
        instancedMesh.material.emissive.copy(col);
        instancedMesh.material.emissiveIntensity = 0.35 + bass * 1.5;
      }
    }

    scene.rotation.y += dt * 0.02;
    controls.update();
    renderer.render(scene, camera);
  });
}
animate();

// resize
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
  </script>
</body>
</html>
