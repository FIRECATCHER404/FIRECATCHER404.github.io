<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tic-Tac-Toe Online</title>

<style>
:root {
  --bg: #0f1220;
  --card: #1a1f3c;
  --accent: #6cf2c2;
  --danger: #ff6b6b;
  --text: #eaeaff;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: radial-gradient(circle at top, #1b1f4a, var(--bg));
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

.card {
  background: var(--card);
  padding: 28px;
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,.4);
  width: 340px;
  text-align: center;
}

h1 {
  margin-top: 0;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: var(--accent);
  color: #003b2a;
  font-weight: 600;
}

button.secondary {
  background: #2b3170;
  color: var(--text);
}

#status {
  margin: 12px 0;
  font-weight: 500;
}

#board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.cell {
  aspect-ratio: 1;
  font-size: 42px;
  background: #11153a;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform .1s, background .2s;
}

.cell:hover {
  background: #181d55;
  transform: scale(1.04);
}

.cell.win {
  background: var(--accent);
  color: #003b2a;
}
</style>
</head>

<body>
<div id="banner" style="
  position: absolute;
  top: 20px;
  font-weight: 600;
  color: #ffb4b4;
  display: none;
">
  Opponent quit round
</div>
<div class="card">
  <h1>Tic-Tac-Toe</h1>

  <div id="menu">
    <button onclick="startAI()">Play vs AI</button>
    <button class="secondary" onclick="startOnline()">Play Online</button>
  </div>

  <div id="status"></div>
  <div id="board"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  set,
  get,
  update,
  onValue,
  remove,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ---------------- Firebase ---------------- */

const firebaseConfig = {
  apiKey: "AIzaSyC4HaUzTDQsz1AKUCsv1ieY5G9WrCyTHrw",
  authDomain: "website-11b5c.firebaseapp.com",
  databaseURL: "https://website-11b5c-default-rtdb.firebaseio.com",
  projectId: "website-11b5c",
  storageBucket: "website-11b5c.appspot.com",
  messagingSenderId: "821866548441",
  appId: "1:821866548441:web:d6941bf79099255f7902c8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------- Game State ---------------- */

const WIN_LINES = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

let board = Array(9).fill("");
let mySymbol = "X";
let myTurn = true;
let gameOver = false;
let gameRef = null;
let mode = null; // "AI" | "ONLINE"

const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const menuEl = document.getElementById("menu");

/* ---------------- UI ---------------- */

function drawBoard(winLine = null) {
  boardEl.innerHTML = "";
  board.forEach((v, i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    if (winLine && winLine.includes(i)) cell.classList.add("win");
    cell.textContent = v;
    cell.onclick = () => clickCell(i);
    boardEl.appendChild(cell);
  });
}

function showQuitBanner() {
  const banner = document.getElementById("banner");
  banner.style.display = "block";
  setTimeout(() => banner.style.display = "none", 4000);
}

function resetToMenu() {
  gameOver = true;

  if (gameRef) {
    remove(gameRef);
    gameRef = null;
  }

  board = Array(9).fill("");
  drawBoard();
  statusEl.textContent = "";
  menuEl.style.display = "block";
}

/* ---------------- Game Logic ---------------- */

function checkWinner() {
  for (const line of WIN_LINES) {
    const [a,b,c] = line;
    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
      return { winner: board[a], line };
    }
  }
  if (board.every(c => c)) return { winner: "draw" };
  return null;
}

function clickCell(i) {
  if (board[i] || !myTurn || gameOver) return;

  board[i] = mySymbol;
  myTurn = false;

  const result = checkWinner();
  if (result) endGame(result);

  drawBoard(result?.line);

  if (mode === "ONLINE" && gameRef) {
    update(gameRef, {
      board,
      turn: myTurn ? mySymbol : other(mySymbol)
    });
  }

  if (mode === "AI" && !result) {
    aiMove();
  }
}

function endGame(result) {
  gameOver = true;
  statusEl.textContent =
    result.winner === "draw"
      ? "Draw!"
      : `${result.winner} wins!`;
}

/* ---------------- AI ---------------- */

window.startAI = () => {
  mode = "AI";
  gameRef = null;

  menuEl.style.display = "none";
  statusEl.textContent = "You are X";

  board = Array(9).fill("");
  mySymbol = "X";
  myTurn = true;
  gameOver = false;

  drawBoard();
};

function aiMove() {
  if (gameOver) return;

  const empty = board.map((v,i)=>v===""?i:null).filter(i=>i!==null);

  // Win
  for (const i of empty) {
    board[i] = "O";
    if (checkWinner()?.winner === "O") return finishAIMove();
    board[i] = "";
  }

  // Block
  for (const i of empty) {
    board[i] = "X";
    if (checkWinner()?.winner === "X") {
      board[i] = "O";
      return finishAIMove();
    }
    board[i] = "";
  }

  // Center
  if (board[4] === "") {
    board[4] = "O";
    return finishAIMove();
  }

  // Random
  board[empty[Math.floor(Math.random()*empty.length)]] = "O";
  finishAIMove();
}

function finishAIMove() {
  myTurn = true;
  const result = checkWinner();
  if (result) endGame(result);
  drawBoard(result?.line);
}

/* ---------------- Online ---------------- */

function listen() {
  statusEl.textContent = "You are " + mySymbol;

  const presenceRef = ref(db, `${gameRef.key}/players/${mySymbol}`);
  set(presenceRef, true);
  onDisconnect(presenceRef).remove();

  onValue(gameRef, snap => {
    const data = snap.val();
    if (!data) return;

    board = data.board;
    myTurn = data.turn === mySymbol;

    const result = checkWinner();
    if (result) endGame(result);

    drawBoard(result?.line);
  });

  const opponentRef = ref(db, `${gameRef.key}/players/${other(mySymbol)}`);
  onValue(opponentRef, snap => {
    if (!snap.exists()) {
      showQuitBanner();
      resetToMenu();
    }
  });
}

window.startOnline = async () => {
  mode = "ONLINE";
  gameOver = false;
  board = Array(9).fill("");
  drawBoard();

  menuEl.style.display = "none";
  statusEl.textContent = "Searching for opponentâ€¦";

  const myId = crypto.randomUUID();
  const waitingRoot = ref(db, "waiting");
  const snap = await get(waitingRoot);

  if (snap.exists()) {
    for (const [id, entry] of Object.entries(snap.val())) {
      if (!entry.gameId) {
        const gameId = crypto.randomUUID();
        gameRef = ref(db, "games/" + gameId);

        mySymbol = "O";
        myTurn = false;

        await set(gameRef, { board: Array(9).fill(""), turn: "X" });
        await update(ref(db, "waiting/" + id), { gameId });

        listen();
        return;
      }
    }
  }

  const myWaitingRef = ref(db, "waiting/" + myId);
  await set(myWaitingRef, { gameId: null });

  mySymbol = "X";
  myTurn = true;

  onValue(myWaitingRef, snap => {
    const data = snap.val();
    if (data?.gameId && !gameRef) {
      gameRef = ref(db, "games/" + data.gameId);
      remove(myWaitingRef);
      listen();
    }
  });
};

function other(s) {
  return s === "X" ? "O" : "X";
}
</script>
</body>
</html>
