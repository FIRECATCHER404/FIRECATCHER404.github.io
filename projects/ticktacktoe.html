<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tic-Tac-Toe Online</title>

<style>
:root {
  --bg: #0f1220;
  --card: #1a1f3c;
  --accent: #6cf2c2;
  --danger: #ff6b6b;
  --text: #eaeaff;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: radial-gradient(circle at top, #1b1f4a, var(--bg));
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

.card {
  background: var(--card);
  padding: 28px;
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,.4);
  width: 340px;
  text-align: center;
}

h1 {
  margin-top: 0;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: var(--accent);
  color: #003b2a;
  font-weight: 600;
}

button.secondary {
  background: #2b3170;
  color: var(--text);
}

#status {
  margin: 12px 0;
  font-weight: 500;
}

#board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.cell {
  aspect-ratio: 1;
  font-size: 42px;
  background: #11153a;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform .1s, background .2s;
}

.cell:hover {
  background: #181d55;
  transform: scale(1.04);
}

.cell.win {
  background: var(--accent);
  color: #003b2a;
}
</style>
</head>

<body>
<div id="banner" style="
  position: absolute;
  top: 20px;
  font-weight: 600;
  color: #ffb4b4;
  display: none;
">
  Opponent quit round
</div>
<div class="card">
  <h1>Tic-Tac-Toe</h1>

  <div id="menu">
    <button onclick="startAI()">Play vs AI</button>
    <button class="secondary" onclick="startOnline()">Play Online</button>
  </div>

  <div id="status"></div>
  <div id="board"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4HaUzTDQsz1AKUCsv1ieY5G9WrCyTHrw",
  authDomain: "website-11b5c.firebaseapp.com",
  databaseURL: "https://website-11b5c-default-rtdb.firebaseio.com",
  projectId: "website-11b5c",
  storageBucket: "website-11b5c.appspot.com",
  messagingSenderId: "821866548441",
  appId: "1:821866548441:web:d6941bf79099255f7902c8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const WIN_LINES = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

let board = Array(9).fill("");
let mySymbol = "X";
let myTurn = true;
let gameOver = false;
let gameRef = null;

const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");
const menuEl = document.getElementById("menu");

function drawBoard(winLine = null) {
  boardEl.innerHTML = "";
  board.forEach((v,i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    if (winLine && winLine.includes(i)) cell.classList.add("win");
    cell.textContent = v;
    cell.onclick = () => clickCell(i);
    boardEl.appendChild(cell);
  });
}

function checkWinner() {
  for (const line of WIN_LINES) {
    const [a,b,c] = line;
    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
      return { winner: board[a], line };
    }
  }
  if (board.every(c => c)) return { winner: "draw" };
  return null;
}

function clickCell(i) {
  if (board[i] || !myTurn || gameOver) return;

  board[i] = mySymbol;
  myTurn = false;

  const result = checkWinner();
  if (result) endGame(result);

  drawBoard(result?.line);

  if (gameRef) {
    update(gameRef, { board, turn: myTurn ? mySymbol : other(mySymbol) });
  } else if (!result) {
    aiMove();
  }
}

/* ---------- AI ---------- */

window.startAI = () => {
  menuEl.style.display = "none";
  statusEl.textContent = "You are X";
  board = Array(9).fill("");
  myTurn = true;
  gameOver = false;
  drawBoard();
};

function aiMove() {
  if (gameOver) return;

  const empty = board.map((v,i)=>v===""?i:null).filter(v=>v!==null);

  // 1ï¸âƒ£ Try to win
  for (const i of empty) {
    board[i] = "O";
    if (checkWinner()?.winner === "O") {
      myTurn = true;
      const result = checkWinner();
      if (result) endGame(result);
      drawBoard(result?.line);
      return;
    }
    board[i] = "";
  }

  // 2ï¸âƒ£ Try to block player
  for (const i of empty) {
    board[i] = "X";
    if (checkWinner()?.winner === "X") {
      board[i] = "O"; // block
      myTurn = true;
      const result = checkWinner();
      if (result) endGame(result);
      drawBoard(result?.line);
      return;
    }
    board[i] = "";
  }

  // 3ï¸âƒ£ Pick center if free
  if (board[4] === "") {
    board[4] = "O";
    myTurn = true;
    const result = checkWinner();
    if (result) endGame(result);
    drawBoard(result?.line);
    return;
  }

  // 4ï¸âƒ£ Pick random
  const move = empty[Math.floor(Math.random()*empty.length)];
  board[move] = "O";
  myTurn = true;
  const result = checkWinner();
  if (result) endGame(result);
  drawBoard(result?.line);
}

function listen() {
  statusEl.textContent = "You are " + mySymbol;

  const presenceRef = ref(db, gameRef.key + "/players/" + mySymbol);
  set(presenceRef, true);

  // Auto-remove player on disconnect
  import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js")
    .then(({ onDisconnect }) => {
      onDisconnect(presenceRef).remove();
    });

  // Listen for game updates
  onValue(gameRef, snap => {
    const data = snap.val();
    if (!data) return;

    board = data.board;
    myTurn = data.turn === mySymbol;

    const result = checkWinner();
    if (result) endGame(result);

    drawBoard(result?.line);
  });

  // ðŸ”´ Detect opponent quit
  const opponentSymbol = other(mySymbol);
  const opponentRef = ref(db, gameRef.key + "/players/" + opponentSymbol);

  onValue(opponentRef, snap => {
    if (!snap.exists()) {
      // Opponent left
      showQuitBanner();
      resetToMenu();
    }
  });
}

window.startOnline = async () => {
  // Reset local state
  board = Array(9).fill("");
  myTurn = true;
  gameOver = false;
  drawBoard();

  menuEl.style.display = "none";
  statusEl.textContent = "Searching for opponentâ€¦";

  const myId = crypto.randomUUID();
  const waitingRoot = ref(db, "waiting");
  const waitingSnap = await get(waitingRoot);

  // 1ï¸âƒ£ Someone is already waiting â†’ join them
  if (waitingSnap.exists()) {
    const entries = Object.entries(waitingSnap.val());

    for (const [otherId, data] of entries) {
      if (data.gameId === null) {
        const gameId = crypto.randomUUID();

        gameRef = ref(db, "games/" + gameId);
        mySymbol = "O";
        myTurn = false;

        await set(gameRef, {
          board: Array(9).fill(""),
          turn: "X"
        });

        // Assign game to waiting player
        await update(ref(db, "waiting/" + otherId), {
          gameId
        });

        listen();
        return;
      }
    }
  }

  // 2ï¸âƒ£ Nobody waiting â†’ put *yourself* in waiting
  const myWaitingRef = ref(db, "waiting/" + myId);
  await set(myWaitingRef, { gameId: null });

  mySymbol = "X";
  myTurn = true;

  // Listen ONLY to your waiting entry
  onValue(myWaitingRef, snap => {
    const data = snap.val();
    if (data?.gameId && !gameRef) {
      gameRef = ref(db, "games/" + data.gameId);
      remove(myWaitingRef); // cleanup
      listen();
    }
  });
};

function endGame(result) {
  gameOver = true;
  if (result.winner === "draw") {
    statusEl.textContent = "Draw!";
  } else {
    statusEl.textContent = result.winner + " wins!";
  }
}

function showQuitBanner() {
  const banner = document.getElementById("banner");
  banner.style.display = "block";
  setTimeout(() => banner.style.display = "none", 4000);
}

function resetToMenu() {
  gameOver = true;
  gameRef = null;
  board = Array(9).fill("");
  drawBoard();
  statusEl.textContent = "";
  menuEl.style.display = "block";
}

  
function other(s) {
  return s === "X" ? "O" : "X";
}
</script>
</body>
</html>
