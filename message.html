<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Messenger</title>
<style>
  :root{
    --bg:#f4f6f8; --panel:#fff; --muted:#667; --accent:#0b84ff;
    --left-width:220px; --left-small:92px; --gap:16px;
  }
  [data-theme="dark"]{
    --bg:#0f1720; --panel:#0b1220; --muted:#9aa; --accent:#4aa3ff;
  }
  *{box-sizing:border-box; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{margin:0; height:100vh; background:var(--bg); color:var(--muted); display:flex; align-items:stretch;}
  /* Layout: left small column, separator, main panel */
  .left-small { width:var(--left-small); background:var(--panel); border-right:1px solid rgba(0,0,0,0.06); display:flex; flex-direction:column; gap:8px; padding:12px; }
  .sep { width:1px; background:transparent; display:flex; align-items:stretch; }
  .left { width:var(--left-width); background:var(--panel); border-right:1px solid rgba(0,0,0,0.06); padding:12px; display:flex; flex-direction:column; gap:8px; }
  .main { flex:1; display:flex; flex-direction:column; gap:8px; }
  /* Header */
  header{height:64px; display:flex; align-items:center; justify-content:space-between; padding:8px 16px; background:linear-gradient(0deg, transparent, transparent); border-bottom:1px solid rgba(0,0,0,0.04);}
  .title {display:flex; align-items:center; gap:12px;}
  .profileCircle { width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700; }
  .hamburger{cursor:pointer;padding:8px;border-radius:8px;}
  .hamburger:hover{transform:scale(1.03);}

  /* Group list */
  .groups { display:flex; flex-direction:column; gap:6px; overflow:auto; padding-right:6px;}
  .groupEntry { padding:8px;border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px; }
  .groupEntry:hover{background:rgba(0,0,0,0.02);}
  .groupEntry.selected{background:rgba(11,132,255,0.08); color:var(--accent)}

  /* Main chat */
  .chatWindow { padding:16px; flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; }
  .message { max-width:65%; padding:10px 12px; border-radius:12px; background:#e9f1ff; color:#063; align-self:flex-start; }
  .message.me { align-self:flex-end; background:linear-gradient(90deg,var(--accent), #6fb8ff); color:#fff; }
  .msgMeta{ font-size:12px; color:rgba(0,0,0,0.45); margin-bottom:6px;}
  .composer { padding:8px; border-top:1px solid rgba(0,0,0,0.06); display:flex; gap:8px; align-items:center; background:var(--panel); }
  .composer input[type="text"]{flex:1;padding:12px;border-radius:20px;border:1px solid rgba(0,0,0,0.06); outline:none; font-size:15px;}
  .btn { border:none; background:var(--accent); color:white;padding:10px 12px;border-radius:12px; cursor:pointer;}
  .btn.secondary{ background:transparent; color:var(--accent); border:1px solid rgba(11,132,255,0.12); }

  /* Controls */
  .controls { display:flex; gap:8px; align-items:center;}
  .small { font-size:13px; padding:6px 8px; border-radius:8px; }

  /* Modal */
  .modalBackdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:50; }
  .modal { background:var(--panel); padding:20px; border-radius:12px; width:min(520px,94%); color:var(--muted); }
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted); margin-bottom:6px;}
  input[type="text"], input[type="password"]{width:100%; padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08); outline:none;}
  .metaLine{font-size:13px;color:var(--muted); margin-top:8px;}

  /* small screens: stack */
  @media (max-width:900px){
    .left { display:none; }
    .left-small { width:64px; }
  }

  /* visual tweaks */
  .muted{color:var(--muted); font-size:13px;}
  .tiny{font-size:12px; color:rgba(0,0,0,0.45);}
  .inviteBadge{background:#fff1c6;padding:4px 8px;border-radius:999px;font-size:12px;}
  .groupActions{display:flex; gap:6px; margin-left:auto;}
  .danger{background:#ffebee;color:#a00}
</style>
</head>
<body>

  <div class="sep"></div>

  <div class="left" id="leftPanel">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <strong>Groups</strong>
      <div class="controls">
        <button class="btn small" id="btnCreateGroup">New</button>
        <button class="btn small secondary" id="btnRefresh">Refresh</button>
      </div>
    </div>
    <div class="groups" id="groupList"></div>
    <hr/>
    <div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <div id="leftProfile" class="profileCircle" style="width:36px;height:36px;"></div>
        <div>
          <div id="displayName" style="font-weight:700"></div>
          <div id="displayHandle" class="tiny"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <header>
      <div class="title">
        <div style="display:flex;flex-direction:column;">
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="unreadBadge" class="inviteBadge" style="display:none;">0</div>
        <div id="rightProfile" style="display:flex;align-items:center;gap:8px;">
          <div id="profileCircleTop" class="profileCircle" style="width:40px;height:40px;"></div>
          <div class="hamburger" id="settingsToggle">☰</div>
        </div>
      </div>
    </header>

    <div id="chat" class="chatWindow"></div>

    <div class="composer">
      <input id="messageInput" type="text" placeholder="Message..." autocomplete="off" />
      <button class="btn" id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Modals and UI panels (hidden by default) -->
  <div id="loginModal" class="modalBackdrop" style="display:none;">
    <div class="modal">
      <h2>Welcome — set your name & password</h2>
      <div class="metaLine">Enter your full name (how you want it displayed) and a password. We'll generate a short username for you.</div>
      <label>Full name</label><input id="fullNameInput" type="text" placeholder="e.g., Jane Doe" />
      <label>Password</label><input id="passwordInput" type="password" />
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn" id="createProfileBtn">Create</button>
      </div>
      <div id="createProfileMsg" class="metaLine"></div>
    </div>
  </div>

  <div id="createGroupModal" class="modalBackdrop" style="display:none;">
    <div class="modal">
      <h3>Create group</h3>
      <label>Group name</label><input id="grpName" type="text" />
      <label>Description (optional)</label><input id="grpDesc" type="text" />
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
        <input id="grpInviteOnly" type="checkbox" /><label style="margin:0">Invite-only</label>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn secondary" id="cancelCreateGrp">Cancel</button>
        <button class="btn" id="confirmCreateGrp">Create</button>
      </div>
      <div id="createGrpMsg" class="metaLine"></div>
    </div>
  </div>

  <div id="joinGroupModal" class="modalBackdrop" style="display:none;">
    <div class="modal">
      <h3>Join group</h3>
      <div id="joinGroupName" class="tiny"></div>
      <label id="joinLabel">Invite code</label><input id="joinCode" type="text" />
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn secondary" id="cancelJoinGrp">Cancel</button>
        <button class="btn" id="confirmJoinGrp">Join</button>
      </div>
      <div id="joinGrpMsg" class="metaLine"></div>
    </div>
  </div>

  <div id="settingsPanel" class="modalBackdrop" style="display:none;">
    <div class="modal">
      <h3>Settings</h3>
      <label>Profile circle background</label>
      <input id="profileColor" type="color" value="#0b84ff" />
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <input id="darkMode" type="checkbox" /><label>Dark mode</label>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn secondary" id="closeSettings">Close</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
import { getDatabase, ref, set, push, onValue } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyC4HaUzTDQsz1AKUCsv1ieY5G9WrCyTHrw",
  authDomain: "website-11b5c.firebaseapp.com",
  databaseURL: "https://website-11b5c-default-rtdb.firebaseio.com",
  projectId: "website-11b5c",
  storageBucket: "website-11b5c.firebasestorage.app",
  messagingSenderId: "821866548441",
  appId: "1:821866548441:web:00a08e534699a6f97902c8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// === DOM Elements ===
const msgInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const settings = document.getElementById('settingsToggle');      // ☰ button
const settingsMenu = document.getElementById('settingsPanel');    // modal backdrop
const darkModeToggle = document.getElementById('darkMode');
const pfpColor = document.getElementById('profileColor');
const usernameInput = document.getElementById('fullNameInput');
const passwordInput = document.getElementById('passwordInput');
const joinBtn = document.getElementById('createProfileBtn');
const groupListDiv = document.getElementById('groupList');
const createGroupBtn = document.getElementById('btnCreateGroup');
const joinGroupBtn = document.getElementById('confirmJoinGrp');
const messages = document.getElementById('chat');

let currentUser = null;
let currentGroupId = null;

// === Helper functions ===
function getInitials(name){
  const words = name.trim().split(' ');
  return words.length === 1
    ? words[0][0].toUpperCase()
    : (words[0][0] + words[words.length-1][0]).toUpperCase();
}

function setCookie(name,value,days=365){
  const d = new Date();
  d.setTime(d.getTime() + days*24*60*60*1000);
  document.cookie = name + '=' + encodeURIComponent(value) + ';path=/;expires=' + d.toUTCString();
}
function getCookie(name){
  const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}

// === Login handling ===
joinBtn.onclick = async () => {
  const name = usernameInput.value.trim();
  const pass = passwordInput.value.trim();
  if (!name || !pass) return alert('Enter both fields');

  currentUser = name;
  setCookie('username', name);
  setCookie('password', pass);

  await set(ref(db, 'users/' + name), { color: localStorage.getItem('pfpColor') || '#4c8bf5' });
  document.getElementById('loginModal').style.display = 'none';
  loadGroups();
};

// === Load groups ===
function loadGroups(){
  const groupsRef = ref(db, 'groups');
  onValue(groupsRef, snapshot => {
    const data = snapshot.val() || {};
    groupListDiv.innerHTML = '';
    for (const id in data){
      const g = data[id];
      const div = document.createElement('div');
      div.textContent = g.name;
      div.className = 'groupEntry';
      div.onclick = () => selectGroup(id);
      groupListDiv.appendChild(div);
    }
  });
}

// === Select group ===
function selectGroup(id){
  currentGroupId = id;
  messages.innerHTML = '';
  const msgsRef = ref(db, 'messages/' + id);
  onValue(msgsRef, snapshot => {
    messages.innerHTML = '';
    const msgs = snapshot.val() || {};
    for (const mid in msgs){
      addMessage(msgs[mid].sender, msgs[mid].text);
    }
  });
}

// === Send message ===
sendBtn.onclick = async () => {
  if (!currentGroupId) return alert('Select a group first');
  const text = msgInput.value.trim();
  if (!text) return;

  const newMsgRef = push(ref(db, 'messages/' + currentGroupId));
  await set(newMsgRef, { sender: currentUser, text, ts: Date.now() });
  msgInput.value = '';
};

// === Add message bubble ===
function addMessage(name, text){
  const msg = document.createElement('div');
  msg.className = 'message' + (name === currentUser ? ' me' : '');
  const meta = document.createElement('div');
  meta.className = 'msgMeta';
  meta.textContent = name;
  const bubble = document.createElement('div');
  bubble.textContent = text;
  msg.appendChild(meta);
  msg.appendChild(bubble);
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}

// === Settings ===
settings.onclick = () => {
  settingsMenu.style.display =
    settingsMenu.style.display === 'none' ? 'flex' : 'none';
};
document.getElementById('closeSettings').onclick = () => {
  settingsMenu.style.display = 'none';
};

// === Profile color ===
pfpColor.oninput = e => {
  localStorage.setItem('pfpColor', e.target.value);
};

// === Dark mode ===
darkModeToggle.onchange = e => {
  document.documentElement.dataset.theme = e.target.checked ? 'dark' : '';
  localStorage.setItem('darkMode', e.target.checked);
};
if (localStorage.getItem('darkMode') === 'true') {
  document.documentElement.dataset.theme = 'dark';
  darkModeToggle.checked = true;
}
if (localStorage.getItem('pfpColor')) {
  pfpColor.value = localStorage.getItem('pfpColor');
}

// === Create / Join groups ===
createGroupBtn.onclick = () => {
  const name = prompt('Group name');
  if (!name) return;
  const id = 'g_' + Date.now().toString(36);
  set(ref(db, 'groups/' + id), { name, owner: currentUser });
};
joinGroupBtn.onclick = () => {
  const id = prompt('Enter group ID to join');
  if (!id) return;
  set(ref(db, 'groups/' + id + '/members/' + currentUser), true);
};

// === Auto login ===
const cookieUser = getCookie('username');
if (cookieUser) {
  currentUser = cookieUser;
  document.getElementById('loginModal').style.display = 'none';
  loadGroups();
} else {
  document.getElementById('loginModal').style.display = 'flex';
}
</script>
</body>
</html>








